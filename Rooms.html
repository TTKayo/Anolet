<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Room</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Styles here (omitted for brevity) */
    </style>
</head>
<body>
    <h1>Welcome, <span id="username"></span>!</h1>
    <h2>Your Unlocked Skins</h2>
    <div id="unlocked-images"></div>

    <h2>Initiate a Trade</h2>
    <input type="text" id="trade-username" placeholder="Enter Username to Trade With">
    <button id="send-trade-request">Send Trade Request</button>

    <h2>Token Balance: <span id="token-balance"></span></h2>
    <div id="trading-room" class="hidden">
        <h2>Trading Room</h2>
        <div class="trade-container">
            <div class="trade-box" id="user-trade-box">
                <h3>Your Offer</h3>
                <div id="user-offer"></div>
                <input type="number" id="user-token-offer" placeholder="Enter tokens to trade">
            </div>
            <div class="trade-box" id="partner-trade-box">
                <h3>Partner's Offer</h3>
                <div id="partner-offer"></div>
                <input type="number" id="partner-token-offer" placeholder="Enter tokens to trade">
            </div>
        </div>
        <button id="accept-trade">Accept Trade</button>
        <button id="decline-trade">Decline Trade</button>
    </div>

    <h2>Profile Picture</h2>
    <img id="profile-picture" src="" alt="Profile Picture">

    <script>
        const firebaseConfig = {
           apiKey: "AIzaSyCOIKlP9YhtX9xa5aoggmsrWwavlW-XuzI",
  authDomain: "cosmik-7c124.firebaseapp.com",
  databaseURL: "https://cosmik-7c124-default-rtdb.firebaseio.com",
  projectId: "cosmik-7c124",
  storageBucket: "cosmik-7c124.appspot.com",
  messagingSenderId: "412506429662",
  appId: "1:412506429662:web:9ca3e17199297df7384a4f",
  measurementId: "G-R7K0LTHCK3"
        };

        firebase.initializeApp(firebaseConfig);
        const firestore = firebase.firestore();

        window.onload = function() {
            const username = getCookie("username");
            document.getElementById('username').innerText = username;

            firestore.collection("users").doc(username).get()
                .then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        const unlockedSkins = userData.unlockedSkins || [];
                        displayUnlockedImages(unlockedSkins);
                        displayProfilePicture(userData.profilePicture);
                        displayTokenBalance(userData.tokens);
                    } else {
                        console.error("No such document!");
                    }
                })
                .catch((error) => {
                    console.error("Error getting document:", error);
                });

            listenToTradeRequests(username);
        };

        function displayUnlockedImages(skins) {
            const container = document.getElementById('unlocked-images');
            container.innerHTML = '';
            skins.forEach(skin => {
                const img = document.createElement('img');
                img.src = skin;
                img.className = 'badge';
                img.onclick = () => addToOffer(img);
                container.appendChild(img);
            });
        }

        function addToOffer(img) {
            const offerContainer = document.getElementById('user-offer');
            if (img.parentElement.id === 'user-offer') {
                img.parentElement.removeChild(img);
                document.getElementById('unlocked-images').appendChild(img);
            } else {
                document.getElementById('unlocked-images').removeChild(img);
                offerContainer.appendChild(img);
            }
        }

        function displayProfilePicture(profilePicture) {
            if (profilePicture) {
                const img = document.getElementById('profile-picture');
                img.src = profilePicture;
                img.classList.add('show');
            }
        }

        function displayTokenBalance(tokens) {
            document.getElementById('token-balance').innerText = tokens;
        }

        function listenToTradeRequests(username) {
            firestore.collection("tradeRequests").doc(username).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.status === 'pending') {
                        Swal.fire({
                            title: 'Trade Request',
                            text: `${data.sender} wants to trade with you. Do you accept?`,
                            icon: 'info',
                            showCancelButton: true,
                            confirmButtonText: 'Accept',
                            cancelButtonText: 'Decline'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                acceptTradeRequest(username, data.sender);
                            } else {
                                declineTradeRequest(username, data.sender);
                            }
                        });
                    }
                }
            });
        }

        function acceptTradeRequest(username, sender) {
            firestore.collection("tradeRequests").doc(username).update({
                status: 'accepted'
            }).then(() => {
                document.getElementById('trading-room').classList.remove('hidden');
                startTrade(username, sender);
            }).catch((error) => {
                console.error("Error accepting trade request: ", error);
            });
        }

        function declineTradeRequest(username, sender) {
            firestore.collection("tradeRequests").doc(username).update({
                status: 'declined'
            }).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Trade Declined',
                    text: 'You have declined the trade.'
                });
            }).catch((error) => {
                console.error("Error declining trade request: ", error);
            });
        }

        document.getElementById('send-trade-request').addEventListener('click', function() {
            const username = getCookie("username");
            const tradeUsername = document.getElementById('trade-username').value;

            firestore.collection("tradeRequests").doc(tradeUsername).set({
                sender: username,
                status: 'pending'
            }).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Trade Request Sent',
                    text: 'Your trade request has been sent.'
                });
            }).catch((error) => {
                console.error("Error sending trade request: ", error);
            });
        });

        document.getElementById('accept-trade').addEventListener('click', function() {
            const username = getCookie("username");
            const tradeUsername = document.getElementById('trade-username').value;
            finalizeTrade(username, tradeUsername);
        });

        document.getElementById('decline-trade').addEventListener('click', function() {
            const username = getCookie("username");
            const tradeUsername = document.getElementById('trade-username').value;
            declineTradeRequest(username, tradeUsername);
        });

        function startTrade(user, partner) {
            // Load initial trade data and listen to trade updates here
            const userOffer = document.getElementById('user-offer');
            const userTokenOffer = document.getElementById('user-token-offer');
            const partnerOffer = document.getElementById('partner-offer');
            const partnerTokenOffer = document.getElementById('partner-token-offer');

            firestore.collection("tradeOffers").doc(user).set({
                partner: partner,
                skins: [],
                tokens: 0
            });

            firestore.collection("tradeOffers").doc(partner).set({
                partner: user,
                skins: [],
                tokens: 0
            });

            firestore.collection("tradeOffers").doc(user).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    updateOfferDisplay(userOffer, data.skins);
                    userTokenOffer.value = data.tokens;
                }
            });

            firestore.collection("tradeOffers").doc(partner).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    updateOfferDisplay(partnerOffer, data.skins);
                    partnerTokenOffer.value = data.tokens;
                }
            });

            userTokenOffer.addEventListener('change', function() {
                updateOffer(user, userOffer, userTokenOffer.value);
            });

            partnerTokenOffer.addEventListener('change', function() {
                updateOffer(partner, partnerOffer, partnerTokenOffer.value);
            });
        }

        function updateOffer(user, offerContainer, tokens) {
            const skins = [];
            offerContainer.querySelectorAll('img').forEach(img => {
                skins.push(img.src);
            });

            firestore.collection("tradeOffers").doc(user).update({
                skins: skins,
                tokens: Number(tokens)
            }).catch((error) => {
                console.error("Error updating offer: ", error);
            });
        }

        function updateOfferDisplay(container, skins) {
            container.innerHTML = '';
            skins.forEach(skin => {
                const img = document.createElement('img');
                img.src = skin;
                img.className = 'badge';
                container.appendChild(img);
            });
        }

        function finalizeTrade(user, partner) {
            const userOffer = document.getElementById('user-offer');
            const userTokenOffer = document.getElementById('user-token-offer').value;
            const partnerOffer = document.getElementById('partner-offer');
            const partnerTokenOffer = document.getElementById('partner-token-offer').value;

            const userSkins = [];
            userOffer.querySelectorAll('img').forEach(img => {
                userSkins.push(img.src);
            });

            const partnerSkins = [];
            partnerOffer.querySelectorAll('img').forEach(img => {
                partnerSkins.push(img.src);
            });

            firestore.runTransaction(async (transaction) => {
                const userDoc = await transaction.get(firestore.collection("users").doc(user));
                const partnerDoc = await transaction.get(firestore.collection("users").doc(partner));

                if (!userDoc.exists || !partnerDoc.exists) {
                    throw "User or Partner document does not exist!";
                }

                const userData = userDoc.data();
                const partnerData = partnerDoc.data();

                // Update unlockedSkins
                const newUserSkins = userData.unlockedSkins.filter(skin => !userSkins.includes(skin)).concat(partnerSkins);
                const newPartnerSkins = partnerData.unlockedSkins.filter(skin => !partnerSkins.includes(skin)).concat(userSkins);

                // Update tokens
                const newUserTokens = userData.tokens - Number(userTokenOffer) + Number(partnerTokenOffer);
                const newPartnerTokens = partnerData.tokens - Number(partnerTokenOffer) + Number(userTokenOffer);

                transaction.update(firestore.collection("users").doc(user), {
                    unlockedSkins: newUserSkins,
                    tokens: newUserTokens
                });

                transaction.update(firestore.collection("users").doc(partner), {
                    unlockedSkins: newPartnerSkins,
                    tokens: newPartnerTokens
                });

                // Remove trade requests and offers
                transaction.delete(firestore.collection("tradeRequests").doc(user));
                transaction.delete(firestore.collection("tradeRequests").doc(partner));
                transaction.delete(firestore.collection("tradeOffers").doc(user));
                transaction.delete(firestore.collection("tradeOffers").doc(partner));
            }).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Trade Completed',
                    text: 'The trade has been successfully completed.'
                });
                document.getElementById('trading-room').classList.add('hidden');
            }).catch((error) => {
                console.error("Error finalizing trade: ", error);
            });
        }

        function getCookie(cname) {
            let name = cname + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) === 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        const username = getCookie("username");
        listenToTradeRequests(username);
    </script>
</body>
</html>
